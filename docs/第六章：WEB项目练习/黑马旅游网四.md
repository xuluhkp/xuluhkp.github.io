# (五)黑马旅游网四
<extoc></extoc>

# 旅游线路详情
## 功能分析
![](assets/markdown-img-paste-20180819231752519.png)

![](assets/markdown-img-paste-20180819231806730.png)
## 代码实现
### 客户端:传递参数,发送请求
#### 用户点击`查看详情`,传递线路id到详情页面
![](assets/markdown-img-paste-20180819223616513.png)
#### 获取线路id,发送异步请求,查询详情数据
```JavaScript
//1.获取rid
 var rid = getParameter("rid");

 //2.发送请求请求 route/findOne
 var url = "/web20/route/findOne";
 var params = {rid:rid};
 $.get(url,params,function (route) {
     // 回调函数,展示数据

     //商家信息展示

     // 线路详情数据

     //线路图片数据
 });

```

### Web层:接收用户请求,调用业务层处理数据
```java
/**
 * 根据id查询一个旅游线路的详细信息
 * @param request
 * @param response
 * @throws ServletException
 * @throws IOException
 */
public void detail(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {

    //1.接收id
    String rid = request.getParameter("rid");
    //2.调用service查询route对象
    Route route = routeService.findById(rid);
    //3.转为json写回客户端
    writeValue(route,response);
}
```
### 业务层:完成业务逻辑处理
#### 接口
```java
/**
 * 根据线路ID查询线路详情
 * @param rid
 * @return
 */
Route findById(String rid);
```
#### 实现类
```java
@Override
public Route findById(String rid) {
    //1.根据id去route表中查询route对象
    Route route = routeDao.findById(Integer.parseInt(rid));

    //2.根据route的id 查询图片集合信息
    List<RouteImg> routeImgList = routeImgDao.findByRid(route.getRid());
    //2.2将集合设置到route对象
    route.setRouteImgList(routeImgList);
    //3.根据route的sid（商家id）查询商家对象
    Seller seller = sellerDao.findById(route.getSid());
    route.setSeller(seller);

    return route;
}
```

### 数据访问层:查询数据
#### 接口`RouteDao`
```java
/**
  * 根据线路id查询线路详情
  * @param rid
  * @return
  */
 Route findById(int rid);
```

#### 实现类`RouteDaoImpl`
```java
@Override
public Route findById(int rid) {
    String sql = "select * from tab_route where rid = ?";
    try {
        return template.queryForObject(sql,new BeanPropertyRowMapper<Route>(Route.class),rid);
    } catch (DataAccessException e) {
        e.printStackTrace();
        return  null ;
    }
}
```

#### 接口`RouteImgDao`
```java
public interface RouteImgDao {

    /**
     * 根据线路id查询线路图片
     * @param rid
     * @return
     */
    public List<RouteImg> findByRid(int rid);
}

```

#### 实现类`RouteImgDaoImpl`
```java
public class RouteImgDaoImpl implements RouteImgDao {

    private JdbcTemplate template = new JdbcTemplate(JDBCUtils.getDataSource());

    @Override
    public List<RouteImg> findByRid(int rid) {
        String sql = "select * from tab_route_img where rid = ? ";
        return template.query(sql,new BeanPropertyRowMapper<RouteImg>(RouteImg.class),rid);
    }
}
```

#### 接口
```java
public interface SellerDao {
    /**
     * 根据线路查询商家
     * @param sid
     * @return
     */
    Seller findById(int sid);
}

```
#### 实现类
```java
public class SellerDaoImpl implements SellerDao {

    private JdbcTemplate template = new JdbcTemplate(JDBCUtils.getDataSource());

    @Override
    public Seller findById(int id) {

        String sql = "select * from tab_seller where sid = ? ";
        return template.queryForObject(sql,new BeanPropertyRowMapper<Seller>(Seller.class),id);
    }
}
```

### 客户端:展示线路详情数据
#### 修改页面,为需要展示数据的标签添加id属性
![](assets/markdown-img-paste-20180820004900192.png)

#### 回调函数中展示数据
```java
//1.获取rid
 var rid = getParameter("rid");

 //2.发送请求请求 route/findOne
 var url = "/web20/route/findOne";
 var params = {rid:rid};
 $.get(url,params,function (route) {
    // 回调函数,展示数据
    //---------------------------------------
     //3.解析数据填充html
     $("#rname").html(route.rname);
     $("#routeIntroduce").html(route.routeIntroduce);
     $("#price").html("¥"+route.price);
     $("#sname").html(route.seller.sname);
     $("#consphone").html(route.seller.consphone);
     $("#address").html(route.seller.address);

     //图片展示
     var ddstr = '<a class="up_img up_img_disable"></a>';

     //遍历routeImgList
     for (var i = 0; i < route.routeImgList.length; i++) {
         var astr ;
         if(i >= 4){
             astr = '<a title="" class="little_img" data-bigpic="'+route.routeImgList[i].bigPic+'" style="display:none;"> <img src="'+route.routeImgList[i].smallPic+'"> </a>';
         }else{
             astr = '<a title="" class="little_img" data-bigpic="'+route.routeImgList[i].bigPic+'"> <img src="'+route.routeImgList[i].smallPic+'"> </a>';
         }
         ddstr += astr;
     }
     ddstr+='<a class="down_img down_img_disable" style="margin-bottom: 0;"></a>';

     $("#dd").html(ddstr);

     $(".big_img").attr("src", $("#dd img:eq(0)").attr("src"));
     //图片展示和切换代码调用
     goImg();
     //-------------------------------------------------------
 });
```
# 旅游线路收藏

## 功能分析
![](assets/markdown-img-paste-20180819231913734.png)

![](assets/markdown-img-paste-2018081923192388.png)

## 需求一:页面判断用户是否已经收藏
### 客户端:发送异步请求判断用户是否已经收藏该线路
```JavaScript
// 发送请求，判断用户是否收藏过该线路
var rid = getParameter("rid");
$.get("route/isFavorite",{rid:rid},function (data) {
    if(data.flag){
        // 用户已经收藏过
        //<a  class="btn already" disabled="disabled">
        //设置收藏按钮的样式
        $("#favorite").addClass("already");
        $("#favorite").attr("disabled","disabled");

        //删除按钮的点击事件
        $("#favorite").off("click");
    }
},'json');
```

### Web层:接收用户请求,调用业务层处理数据
```java
/**
 * 判断当前登录用户是否收藏过该线路
 * @param request
 * @param response
 * @throws ServletException
 * @throws IOException
 */
public void isFavorite(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    //1. 获取线路id
    String rid = request.getParameter("rid");
    //2. 获取当前登录的用户 user
    User user = (User) request.getSession().getAttribute("user");
    int uid;//用户id
    if (user == null) {
        //用户尚未登录
        uid = 0;
    } else {
        //用户已经登录
        uid = user.getUid();
    }
    //3. 调用FavoriteService查询是否收藏
    Favorite favorite = favoriteService.isFavorite(rid, uid);
    ResultInfo info = new ResultInfo();
    if(favorite==null){
        info.setFlag(true);  //已收藏
    }else{
        info.setFlag(false); //未收藏
    }
    //4. 写回客户端
    writeValue(info, response);
}
```
### 业务层
#### 接口`FavoriteService`
```java
public interface FavoriteService {

    /**
     * 判断是否收藏
     * @param rid
     * @param uid
     * @return
     */
    public Favorite isFavorite(String rid, int uid);
}
```
#### 实现类`FavoriteServiceImpl`
```java
public class FavoriteServiceImpl implements FavoriteService {

    private FavoriteDao favoriteDao = new FavoriteDaoImpl();

    @Override
    public Favorite isFavorite(String rid, int uid) {

        Favorite favorite = favoriteDao.findByRidAndUid(Integer.parseInt(rid), uid);

        return favorite ;//如果对象有值，则为true，反之，则为false
    }
}
```

### 数据访问层
#### 接口`FavoriteDao`
```java
public interface FavoriteDao {
    /**
     * 根据rid和uid查询收藏信息
     * @param rid
     * @param uid
     * @return
     */
    public Favorite findByRidAndUid(int rid, int uid);
}
```
#### 实现类`FavoriteDaoImpl`
```java
public class FavoriteDaoImpl implements FavoriteDao {

    private JdbcTemplate template = new JdbcTemplate(JDBCUtils.getDataSource());

    @Override
    public Favorite findByRidAndUid(int rid, int uid) {
        Favorite favorite = null;
        try {
            String sql = " select * from tab_favorite where rid = ? and uid = ?";
            favorite = template.queryForObject(sql, new BeanPropertyRowMapper<Favorite>(Favorite.class), rid, uid);
        } catch (DataAccessException e) {
            e.printStackTrace();
        }
        return favorite;
    }
}
```

### 客户端:回调函数中处理响应数据
```JavaScript
// 发送请求，判断用户是否收藏过该线路
var rid = getParameter("rid");
$.get("route/isFavorite",{rid:rid},function (data) {
    //回调函数中处理数据
    //----------------------
    if(data.flag){
        // 用户已经收藏过
        //<a  class="btn already" disabled="disabled">
        //设置收藏按钮的样式
        $("#favorite").addClass("already");
        $("#favorite").attr("disabled","disabled");

        //删除按钮的点击事件
        $("#favorite").off("click");
    }
    //----------------------
},'json');
```

## 需求二:用户收藏功能
### 客户端:用户点击收藏,发送请求,完成收藏操作
```JavaScript
//用户点击收藏按钮
$("#addFavorite").click(function () {
    var rid = getParameter("rid");
    //1. 判断用户是否登录
    var url = "/web20/user/logined";
    $.get(url,  function (data) {
        if (data.flag) {
            //用户登录了
            //添加功能
            var url = "/web20/route/addFavorite";
            var params = {rid: rid} ;
            $.get(url, params, function () {
                //代码刷新页面
                location.reload();
            });
        } else {
            //用户没有登录
            alert("您尚未登录，请登录");
            location.href = "/web20/login.html";
        }
    },'json')
});
```
### Web层:接收用户请求,调用业务层完成业务逻辑处理
```java
/**
 * 添加收藏
 * @param request
 * @param response
 * @throws ServletException
 * @throws IOException
 */
public void addFavorite(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    //1. 获取线路rid
    String rid = request.getParameter("rid");
    //2. 获取当前登录的用户
    User user = (User) request.getSession().getAttribute("user");
    int uid;//用户id
    if (user == null) {
        //用户尚未登录
        return;
    } else {
        //用户已经登录
        uid = user.getUid();
    }
    //3. 调用service添加
    favoriteService.add(rid, uid);
}
```
### 业务层:调用业务层处理数据
#### 接口`FavoriteService`
```java
/**
 * 添加收藏
 * @param rid
 * @param uid
 */
void add(String rid, int uid);
```
#### 实现类`FavoriteServiceImpl`
```java
@Override
public void add(String rid, int uid) {
    favoriteDao.add(Integer.parseInt(rid),uid);
}
```
### 数据访问层
#### 接口`FavoriteDao`
```java
/**
 * 添加收藏
 * @param i
 * @param uid
 */
void add(int i, int uid);
```
#### 实现类`FavoriteDaoImpl`
```java
@Override
public void add(int rid, int uid) {
    String sql = "insert into tab_favorite values(?,?,?)";
    template.update(sql,rid,new Date(),uid);
}
```

### 客户端:回调函数中处理响应数据
```JavaScript
//用户点击收藏按钮
$("#addFavorite").click(function () {
    var rid = getParameter("rid");
    //1. 判断用户是否登录
    var url = "/web20/user/logined";
    $.get(url,  function (data) {
        //回调函数,处理响应数据
        //----------------------
        if (data.flag) {
            //用户登录了
            //添加功能
            var url = "/web20/route/addFavorite";
            var params = {rid: rid} ;
            $.get(url, params, function () {
                //代码刷新页面
                location.reload();
            });
        } else {
            //用户没有登录
            alert("您尚未登录，请登录");
            location.href = "/web20/login.html";
        }
        //----------------------
    },'json')
});
```

# (六)黑马旅游网五
<extoc></extoc>

# 收藏排行榜
## 功能分析
![](assets/markdown-img-paste-20180821102212313.png)

## 准备
### 页面修改
![](assets/markdown-img-paste-20180821102633317.png)

### 条件封装实体类创建
```java
package com.itheima.bean;

public class Condition {

    private int currentPage  = 1 ;

    private int rows = 10 ;

    private String rname ;

    private double maxPrice ;

    private  double minPrice ;

    public int getCurrentPage() {
        if(currentPage<=0){
            currentPage = 1 ;
        }

        return currentPage;
    }

    public void setCurrentPage(int currentPage) {
        this.currentPage = currentPage;
    }

    public int getRows() {
        if(rows<=0){
            rows = 5 ;
        }
        return rows;
    }

    public void setRows(int rows) {
        this.rows = rows;
    }

    public String getRname() {
        if("null".equals(rname)){
            rname = null ;
        }

        return rname;
    }

    public void setRname(String rname) {
        this.rname = rname;
    }

    public double getMaxPrice() {
        return maxPrice;
    }

    public void setMaxPrice(double maxPrice) {
        this.maxPrice = maxPrice;
    }

    public double getMinPrice() {
        return minPrice;
    }

    public void setMinPrice(double minPrice) {
        this.minPrice = minPrice;
    }
}
```

## 代码实现
### 数据访问层:查询数据库

可以预期,数据访问层是根据传入的条件进行动态sql拼接查询的

#### 接口`RouteDao`
```java
/**
 * 查询收藏数量
 * @param condition
 * @return
 */
int pageFavoriteRouteCount(Condition condition);

/**
 * 查询收藏线路信息
 * @param condition
 * @return
 */
List<Route> pageFavoriteRoute(Condition condition);
```

#### 实现类`RouteDaoImpl`
```java
@Override
public int pageFavoriteRouteCount(Condition condition) {
    //拼接sql语句 动态sql
    String sql = "SELECT COUNT(*) FROM  ( SELECT DISTINCT r.rid FROM tab_favorite f INNER JOIN tab_route r ON f.rid = r.rid where 1=1 ";
    StringBuilder sb = new StringBuilder(sql);

    //定义参数集合
    List<Object> params = new ArrayList<Object>();
    // 用户输入rname
    if(StringUtils.isNotBlank(condition.getRname())){
        sb.append(" and r.rname like ? ");
        params.add("%"+condition.getRname()+"%");
    }

    //用户输入最小价格
    if(condition.getMinPrice()>0){
        sb.append(" and r.price > ?  ");
        params.add(condition.getMinPrice());
    }

    //用户输入最大价格
    if(condition.getMaxPrice()>0){
        sb.append(" and r.price < ?  ");
        params.add(condition.getMaxPrice());
    }

    sb.append(" ) t  ");

    Integer count = template.queryForObject(sb.toString(),  params.toArray(),Integer.class);

    return count;
}

@Override
public List<Route> pageFavoriteRoute(Condition condition) {
    //拼接sql语句 动态sql
    String sql = "SELECT COUNT(*) `count`,r.rid,r.rname,r.price,r.rimage,r.routeIntroduce FROM tab_favorite f INNER JOIN tab_route r ON f.rid = r.rid where 1=1    ";
    StringBuilder sb = new StringBuilder(sql);

    //定义参数集合
    List<Object> params = new ArrayList<Object>();
    // 用户输入rname
    if(StringUtils.isNotBlank(condition.getRname())){
        sb.append(" and r.rname like ? ");
        params.add("%"+condition.getRname()+"%");
    }

    //用户输入最小价格
    if(condition.getMinPrice()>0){
        sb.append(" and r.price > ?  ");
        params.add(condition.getMinPrice());
    }

    //用户输入最大价格
    if(condition.getMaxPrice()>0){
        sb.append(" and r.price < ?  ");
        params.add(condition.getMaxPrice());
    }

    sb.append(" GROUP BY f.rid  order by count desc  limit ?,?  ");
    params.add((condition.getCurrentPage()-1)*condition.getRows());
    params.add(condition.getRows());

    List<Route> list = template.query(sb.toString(), new BeanPropertyRowMapper<Route>(Route.class), params.toArray());

    return list;
}
```

### 业务层:完成分页数据封装
#### 接口`RouteService`
```java
/**
 * 线路收藏排序查询
 * @param condition
 * @return
 */
PageBean<Route> pageFavoriteRoute(Condition condition);
```

#### 实现类`RouteServiceImpl`
```java
@Override
public PageBean<Route> pageFavoriteRoute(Condition condition) {
    //创建pageBean对象
    PageBean<Route> pb = new PageBean<Route>();
    //封装数据
    pb.setCurrentPage(condition.getCurrentPage());
    pb.setPageSize(condition.getRows());

    //查询数据总条数
    int totalCount = routeDao.pageFavoriteRouteCount(condition);
    pb.setTotalCount(totalCount);

    //计算总页数
    int totalPage = (int) Math.ceil(totalCount*1.0/condition.getRows());
    pb.setTotalPage(totalPage);

    // 查询收藏分类列表
    List<Route> list = routeDao.pageFavoriteRoute(condition);
    pb.setList(list);

    return pb;
}
```

### Web层:接收用户请求,调用业务层完成业务逻辑处理
```java
/**
 * 收藏列表展示
 * @param request
 * @param response
 * @throws ServletException
 * @throws IOException
 */
public void favoriteList(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    //1.获取参数
    Map<String, String[]> params = request.getParameterMap();

    //2. 封装搜索数据
    Condition condition = new Condition();
    try {
        BeanUtils.populate(condition, params);
    } catch (Exception e) {
        e.printStackTrace();
    }


    //2. 调用业务层获取线路数据
    PageBean<Route> pb = routeService.pageFavoriteRoute(condition);

    //3. 将数据转化为json
    ResultInfo info = new ResultInfo();
    info.setFlag(true);
    info.setData(pb);
    writeValue(info, response);
}
```

### 客户端:发送异步请求,访问客户端获取数据,展示数据
#### 修改页面
![](assets/markdown-img-paste-20180821103418435.png)

#### 发送异步请求
```JavaScript
<script>
$(function () {
    //用户点击搜索按钮
    $("#serachBtn").click(function () {
        //调用搜索方法
        search(1, 4);
    });

    //页面加载完成调用搜索方法
    search(1, 4);
})

function search(currentPage, rows) {
    //定义请求路径
    var url = "/web20/route/favoriteList";
    //获取用户输入的数据
    var serachParams = $("#serachForm").serialize();
    var params = serachParams + "&currentPage=" + currentPage + "&rows=" + rows;
    $.get(url, params, function (data) {
        var pb = data.data;
        var routes = pb.list;

        //展示数据列表
        var rhtml = "";
        for (var i = 0; i < routes.length; i++) {
            var route = routes[i];
            var num = i + (pb.currentPage - 1) * (pb.pageSize);
            switch (num) {
                case 0:
                    rhtml += "<li><span class='num one'>" + (num + 1) + "</span><a href='route_detail.html?rid=" + route.rid + "'><img src='" + route.rimage + "' alt=''></a><h4><a href='route_detail.html?rid=" + route.rid + "'>" + route.rname + "</a></h4><p><b class='price'>&yen;<span>" + route.price + "</span>起</b><span class='shouchang'>已收藏" + route.count + "次</span></p></li>";
                    break;
                case 1:
                    rhtml += "<li><span class='num two'>" + (num + 1) + "</span><a href='route_detail.html?rid=" + route.rid + "'><img src='" + route.rimage + "' alt=''></a><h4><a href='route_detail.html?rid=" + route.rid + "'>" + route.rname + "</a></h4><p><b class='price'>&yen;<span>" + route.price + "</span>起</b><span class='shouchang'>已收藏" + route.count + "次</span></p></li>"
                    break;
                default:
                    rhtml += "<li><span class='num'>" + (num + 1) + "</span><a href='route_detail.html?rid=" + route.rid + "'><img src='" + route.rimage + "' alt=''></a><h4><a href='route_detail.html?rid=" + route.rid + "'>" + route.rname + "</a></h4><p><b class='price'>&yen;<span>" + route.price + "</span>起</b><span class='shouchang'>已收藏" + route.count + "次</span></p></li>"
            }

        }

        $("#route_list").html(rhtml);

        //展示分页条
        $('#pagination3').bootstrapPaginator({
            size: "normal",
            bootstrapMajorVersion: 3,
            currentPage: pb.currentPage,
            numberOfPages: 10,
            totalPages: pb.totalPage,
            alignment: "center",
            itemTexts: function (type, page, current) {
                switch (type) {
                    case "first":
                        return "首页";
                    case "prev":
                        return "上一页";
                    case "next":
                        return "下一页";
                    case "last":
                        return "尾页";
                    case "page":
                        return page;
                }
            },
            onPageClicked: function (e, originalEvent, type, page) {
                search(page, 4);
            }
        });

        //定位到页面顶部
        window.scrollTo(0, 0);

    }, 'json');
}

</script>
```
